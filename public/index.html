<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML to PDF Resume Maker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #e9ecef;
        }

        .section h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        /* Template Selector Styles */
        .template-selector {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }

        .template-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .template-option {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .template-option:hover {
            border-color: #667eea;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .template-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .template-option h4 {
            color: #495057;
            margin-bottom: 10px;
        }

        .template-option p {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .template-preview {
            width: 100%;
            height: 120px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #6c757d;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .preview {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .resume-template {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .resume-header {
            text-align: center;
            border-bottom: 2px solid #667eea;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .resume-header h1 {
            color: #667eea;
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .resume-section {
            margin-bottom: 20px;
        }

        .resume-section h3 {
            color: #495057;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        .contact-info {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .contact-info span {
            color: #6c757d;
        }

        .experience-item, .education-item {
            margin-bottom: 15px;
        }

        .experience-item h4, .education-item h4 {
            color: #667eea;
            margin-bottom: 5px;
        }

        .experience-item p, .education-item p {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .skills {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .skill-tag {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        /* Dynamic Sections Styles */
        .sections-container {
            margin-top: 20px;
        }

        .section-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
            transition: all 0.3s;
        }

        .section-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .section-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .section-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .section-title {
            font-weight: 600;
            color: #495057;
            flex-grow: 1;
        }

        .section-controls {
            display: flex;
            gap: 5px;
        }

        .section-controls button {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 5px;
        }

        .drag-handle {
            cursor: move;
            color: #6c757d;
            margin-right: 10px;
        }

        .section-content {
            margin-top: 10px;
        }

        .add-section-form {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .section-type-selector {
            margin-bottom: 20px;
        }

        .section-type-selector label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #495057;
        }

        .section-type-selector select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }

        /* Enhanced Preview Styles */
        .preview-container {
            position: relative;
            margin-bottom: 15px;
        }

        .resume-template.a4-mode {
            width: 210mm;
            height: 297mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            transform: scale(0.8);
            transform-origin: top center;
            border: 1px solid #ddd;
            overflow: hidden;
        }

        .resume-template.a4-mode .resume-header h1 {
            font-size: 1.8rem;
        }

        .resume-template.a4-mode .resume-section {
            margin-bottom: 15px;
        }

        .resume-template.a4-mode .resume-section h3 {
            font-size: 1.1rem;
        }

        .resume-template.a4-mode .contact-info {
            font-size: 0.8rem;
        }

        .preview-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .preview-controls button {
            font-size: 14px;
            padding: 8px 15px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .resume-template.a4-mode {
                transform: scale(0.6);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÑ Dynamic HTML to PDF Resume Maker</h1>
            <p>Create professional A4 PDF resumes with custom sections</p>
        </div>

        <!-- Template Selector -->
        <div class="template-selector">
            <h2>üé® Choose Your Resume Template</h2>
            <div class="template-options">
                <div class="template-option selected" onclick="selectTemplate('modern')">
                    <div class="template-preview" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 5px;">MODERN</div>
                            <div style="font-size: 0.7rem;">Clean & Professional</div>
                        </div>
                    </div>
                    <h4>Modern Professional</h4>
                    <p>Clean design with gradient header and organized sections</p>
                </div>
                <div class="template-option" onclick="selectTemplate('minimal')">
                    <div class="template-preview" style="background: #f8f9fa; border: 2px solid #495057;">
                        <div style="text-align: center; color: #495057;">
                            <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 5px;">MINIMAL</div>
                            <div style="font-size: 0.7rem;">Simple & Elegant</div>
                        </div>
                    </div>
                    <h4>Minimal Elegant</h4>
                    <p>Simple layout with focus on content and readability</p>
                </div>
                <div class="template-option" onclick="selectTemplate('creative')">
                    <div class="template-preview" style="background: linear-gradient(45deg, #ff6b6b, #4ecdc4); color: white;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 5px;">CREATIVE</div>
                            <div style="font-size: 0.7rem;">Bold & Colorful</div>
                        </div>
                    </div>
                    <h4>Creative Bold</h4>
                    <p>Vibrant colors and modern typography for creative professionals</p>
                </div>
                <div class="template-option" onclick="selectTemplate('corporate')">
                    <div class="template-preview" style="background: #2c3e50; color: white;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 5px;">CORPORATE</div>
                            <div style="font-size: 0.7rem;">Traditional & Formal</div>
                        </div>
                    </div>
                    <h4>Corporate Traditional</h4>
                    <p>Classic business style with formal layout and typography</p>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Input Section -->
            <div class="section">
                <h2>üìù Create Your Resume</h2>
                
                <div class="input-group">
                    <label for="name">Full Name</label>
                    <input type="text" id="name" placeholder="John Doe">
                </div>

                <div class="input-group">
                    <label for="title">Professional Title</label>
                    <input type="text" id="title" placeholder="Software Engineer">
                </div>

                <div class="input-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" placeholder="john.doe@email.com">
                </div>

                <div class="input-group">
                    <label for="phone">Phone</label>
                    <input type="tel" id="phone" placeholder="+1 (555) 123-4567">
                </div>

                <div class="input-group">
                    <label for="location">Location</label>
                    <input type="text" id="location" placeholder="New York, NY">
                </div>

                <div class="input-group">
                    <label for="linkedin">LinkedIn (Optional)</label>
                    <input type="url" id="linkedin" placeholder="linkedin.com/in/johndoe">
                </div>

                <h3 style="margin-top: 30px; color: #495057;">üìã Resume Sections</h3>
                
                <div class="sections-container" id="sectionsContainer">
                    <!-- Sections will be added here dynamically -->
                </div>

                <div class="add-section-form">
                    <h4 style="margin-bottom: 15px; color: #495057;">‚ûï Add New Section</h4>
                    
                    <div class="section-type-selector">
                        <label for="sectionType">Section Type</label>
                        <select id="sectionType">
                            <option value="summary">Professional Summary</option>
                            <option value="experience">Work Experience</option>
                            <option value="education">Education</option>
                            <option value="skills">Skills</option>
                            <option value="projects">Projects</option>
                            <option value="certifications">Certifications</option>
                            <option value="custom">Custom Section</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="input-group">
                            <label for="sectionTitle">Section Title</label>
                            <input type="text" id="sectionTitle" placeholder="e.g., Work Experience">
                        </div>
                        <div class="input-group">
                            <label for="sectionContent">Content</label>
                            <textarea id="sectionContent" rows="4" placeholder="Enter your content here..."></textarea>
                        </div>
                    </div>

                    <button class="btn btn-success" onclick="addSection()">Add Section</button>
                </div>

                <div style="margin-top: 30px;">
                    <button class="btn" onclick="generateResume()">Generate Resume</button>
                    <button class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
                </div>

                <!-- Data Persistence Section -->
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 1px solid #e9ecef;">
                    <h3 style="margin-bottom: 15px; color: #495057;">üíæ Save & Load Resume</h3>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                        <button class="btn btn-success" onclick="saveResume()">
                            üíæ Save Resume
                        </button>
                        <button class="btn btn-secondary" onclick="loadResume()">
                            üìÇ Load Resume
                        </button>
                        <button class="btn btn-secondary" onclick="exportResume()">
                            üì§ Export Data
                        </button>
                        <button class="btn btn-secondary" onclick="importResume()">
                            üì• Import Data
                        </button>
                    </div>

                    <!-- Saved Resumes List -->
                    <div id="savedResumesList" style="margin-top: 15px;">
                        <h4 style="margin-bottom: 10px; color: #495057;">üìã Saved Resumes:</h4>
                        <div id="resumesList" style="max-height: 200px; overflow-y: auto;">
                            <!-- Saved resumes will appear here -->
                        </div>
                    </div>

                    <!-- Auto-save indicator -->
                    <div style="margin-top: 10px; font-size: 0.9rem; color: #6c757d;">
                        <span id="autoSaveStatus">‚úÖ Auto-save enabled</span>
                        <span id="lastSaved" style="margin-left: 10px;"></span>
                    </div>
                </div>
            </div>

            <!-- Preview Section -->
            <div class="section">
                <h2>üëÅÔ∏è Resume Preview</h2>
                
                <!-- Preview Controls -->
                <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="togglePreviewMode()" id="previewModeBtn">
                        üìÑ A4 Preview
                    </button>
                    <button class="btn btn-secondary" onclick="refreshPreview()">
                        üîÑ Refresh Preview
                    </button>
                    <button class="btn btn-secondary" onclick="printPreview()">
                        üñ®Ô∏è Print Preview
                    </button>
                </div>

                <!-- Preview Container -->
                <div class="preview-container">
                    <div id="resumePreview" class="resume-template">
                        <div class="resume-header">
                            <h1>Your Name</h1>
                            <p>Professional Title</p>
                            <div class="contact-info">
                                <span>üìß email@example.com</span>
                                <span>üì± +1 (555) 123-4567</span>
                                <span>üìç Location</span>
                            </div>
                        </div>
                        
                        <div class="resume-section">
                            <h3>Professional Summary</h3>
                            <p>Your professional summary will appear here...</p>
                        </div>

                        <div class="resume-section">
                            <h3>Work Experience</h3>
                            <p>Your work experience will appear here...</p>
                        </div>

                        <div class="resume-section">
                            <h3>Education</h3>
                            <p>Your education will appear here...</p>
                        </div>

                        <div class="resume-section">
                            <h3>Skills</h3>
                            <div class="skills">
                                <span class="skill-tag">Skill 1</span>
                                <span class="skill-tag">Skill 2</span>
                                <span class="skill-tag">Skill 3</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Preview Info -->
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 0.9rem; color: #6c757d;">
                    <strong>üí° Preview Tips:</strong>
                    <ul style="margin: 5px 0 0 20px;">
                        <li>Preview updates automatically as you type</li>
                        <li>Drag sections to reorder them</li>
                        <li>Use A4 Preview to see how it will look on paper</li>
                        <li>Click "Print Preview" to test printing</li>
                    </ul>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn" onclick="downloadPDF()">üì• Download PDF</button>
                    <button class="btn btn-secondary" onclick="uploadHTML()">üìÅ Upload HTML File</button>
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Generating PDF...</p>
                </div>

                <!-- Hidden file input for import -->
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImportFile(event)">
            </div>
        </div>

        <!-- File Upload Section -->
        <div style="padding: 30px;">
            <div class="section">
                <h2>üìÅ Upload HTML File</h2>
                <div class="file-upload" onclick="document.getElementById('htmlFile').click()">
                    <input type="file" id="htmlFile" accept=".html" onchange="handleFileUpload()">
                    <p>üìé Click to upload HTML file</p>
                    <p style="font-size: 0.9rem; color: #6c757d;">or drag and drop here</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let sections = [];
        let sectionCounter = 0;

        // Initialize default sections
        const defaultSections = [
            { id: 'summary', title: 'Professional Summary', content: 'Your professional summary will appear here...', type: 'summary' },
            { id: 'experience', title: 'Work Experience', content: 'Your work experience will appear here...', type: 'experience' },
            { id: 'education', title: 'Education', content: 'Your education will appear here...', type: 'education' },
            { id: 'skills', title: 'Skills', content: 'Skill 1, Skill 2, Skill 3', type: 'skills' }
        ];

        // Initialize sections
        function initializeSections() {
            sections = [...defaultSections];
            renderSections();
            updatePreview();
        }

        // Render sections in the container
        function renderSections() {
            const container = document.getElementById('sectionsContainer');
            container.innerHTML = '';

            sections.forEach((section, index) => {
                const sectionElement = createSectionElement(section, index);
                container.appendChild(sectionElement);
            });
        }

        // Create section element
        function createSectionElement(section, index) {
            const div = document.createElement('div');
            div.className = 'section-item';
            div.draggable = true;
            div.dataset.index = index;

            div.innerHTML = `
                <div class="section-header">
                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                    <span class="section-title">${section.title}</span>
                    <div class="section-controls">
                        <button class="btn btn-secondary" onclick="editSection(${index})" style="padding: 5px 10px; font-size: 12px;">Edit</button>
                        <button class="btn btn-danger" onclick="removeSection(${index})" style="padding: 5px 10px; font-size: 12px;">Remove</button>
                    </div>
                </div>
                <div class="section-content">
                    <small style="color: #6c757d;">${section.type} ‚Ä¢ ${section.content.substring(0, 50)}${section.content.length > 50 ? '...' : ''}</small>
                </div>
            `;

            // Add drag and drop functionality
            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragover', handleDragOver);
            div.addEventListener('drop', handleDrop);
            div.addEventListener('dragend', handleDragEnd);

            return div;
        }

        // Drag and drop functionality
        function handleDragStart(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.setData('text/plain', e.target.dataset.index);
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDrop(e) {
            e.preventDefault();
            const draggedIndex = parseInt(e.dataTransfer.getData('text/plain'));
            const dropIndex = parseInt(e.target.closest('.section-item').dataset.index);
            
            if (draggedIndex !== dropIndex) {
                moveSection(draggedIndex, dropIndex);
            }
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        // Move section
        function moveSection(fromIndex, toIndex) {
            const section = sections.splice(fromIndex, 1)[0];
            sections.splice(toIndex, 0, section);
            renderSections();
            updatePreview();
        }

        // Add new section
        function addSection() {
            const type = document.getElementById('sectionType').value;
            const title = document.getElementById('sectionTitle').value || getDefaultTitle(type);
            const content = document.getElementById('sectionContent').value || getDefaultContent(type);

            if (!title.trim()) {
                alert('Please enter a section title');
                return;
            }

            const newSection = {
                id: `section_${sectionCounter++}`,
                title: title,
                content: content,
                type: type
            };

            sections.push(newSection);
            renderSections();
            updatePreview();

            // Clear form
            document.getElementById('sectionTitle').value = '';
            document.getElementById('sectionContent').value = '';
        }

        // Edit section
        function editSection(index) {
            const section = sections[index];
            document.getElementById('sectionType').value = section.type;
            document.getElementById('sectionTitle').value = section.title;
            document.getElementById('sectionContent').value = section.content;
            
            // Remove the old section
            sections.splice(index, 1);
            renderSections();
            updatePreview();
        }

        // Remove section
        function removeSection(index) {
            if (confirm('Are you sure you want to remove this section?')) {
                sections.splice(index, 1);
                renderSections();
                updatePreview();
            }
        }

        // Get default title based on type
        function getDefaultTitle(type) {
            const titles = {
                'summary': 'Professional Summary',
                'experience': 'Work Experience',
                'education': 'Education',
                'skills': 'Skills',
                'projects': 'Projects',
                'certifications': 'Certifications',
                'custom': 'Custom Section'
            };
            return titles[type] || 'Custom Section';
        }

        // Get default content based on type
        function getDefaultContent(type) {
            const contents = {
                'summary': 'Your professional summary will appear here...',
                'experience': 'Your work experience will appear here...',
                'education': 'Your education will appear here...',
                'skills': 'Skill 1, Skill 2, Skill 3',
                'projects': 'Your projects will appear here...',
                'certifications': 'Your certifications will appear here...',
                'custom': 'Your custom content will appear here...'
            };
            return contents[type] || 'Your content will appear here...';
        }

        // Update preview in real-time
        function updatePreview() {
            const name = document.getElementById('name').value || 'Your Name';
            const title = document.getElementById('title').value || 'Professional Title';
            const email = document.getElementById('email').value || 'email@example.com';
            const phone = document.getElementById('phone').value || '+1 (555) 123-4567';
            const location = document.getElementById('location').value || 'Location';
            const linkedin = document.getElementById('linkedin').value || '';

            const preview = document.getElementById('resumePreview');
            
            let contactInfo = `
                <span>üìß ${email}</span>
                <span>üì± ${phone}</span>
                <span>üìç ${location}</span>
            `;
            
            if (linkedin) {
                contactInfo += `<span>üîó ${linkedin}</span>`;
            }

            let sectionsHTML = '';
            sections.forEach(section => {
                if (section.type === 'skills') {
                    const skills = section.content.split(',').map(skill => skill.trim());
                    sectionsHTML += `
                        <div class="resume-section">
                            <h3>${section.title}</h3>
                            <div class="skills">
                                ${skills.map(skill => `<span class="skill-tag">${skill}</span>`).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    sectionsHTML += `
                        <div class="resume-section">
                            <h3>${section.title}</h3>
                            <p>${section.content.replace(/\n/g, '<br>')}</p>
                        </div>
                    `;
                }
            });

            // Apply template-specific styling
            const templateStyles = getTemplateStyles(selectedTemplate);
            
            preview.innerHTML = `
                <style>${templateStyles}</style>
                <div class="resume-header resume-${selectedTemplate}">
                    <h1>${name}</h1>
                    <p>${title}</p>
                    <div class="contact-info">
                        ${contactInfo}
                    </div>
                </div>
                ${sectionsHTML}
            `;
        }

        // Add event listeners for real-time preview
        document.getElementById('name').addEventListener('input', updatePreview);
        document.getElementById('title').addEventListener('input', updatePreview);
        document.getElementById('email').addEventListener('input', updatePreview);
        document.getElementById('phone').addEventListener('input', updatePreview);
        document.getElementById('location').addEventListener('input', updatePreview);
        document.getElementById('linkedin').addEventListener('input', updatePreview);

        // Generate resume HTML
        function generateResume() {
            const name = document.getElementById('name').value || 'Your Name';
            const title = document.getElementById('title').value || 'Professional Title';
            const email = document.getElementById('email').value || 'email@example.com';
            const phone = document.getElementById('phone').value || '+1 (555) 123-4567';
            const location = document.getElementById('location').value || 'Location';
            const linkedin = document.getElementById('linkedin').value || '';

            let contactInfo = `
                <span>üìß ${email}</span>
                <span>üì± ${phone}</span>
                <span>üìç ${location}</span>
            `;
            
            if (linkedin) {
                contactInfo += `<span>üîó ${linkedin}</span>`;
            }

            let sectionsHTML = '';
            sections.forEach(section => {
                if (section.type === 'skills') {
                    const skills = section.content.split(',').map(skill => skill.trim());
                    sectionsHTML += `
                        <div class="resume-section">
                            <h3>${section.title}</h3>
                            <div class="skills">
                                ${skills.map(skill => `<span class="skill-tag">${skill}</span>`).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    sectionsHTML += `
                        <div class="resume-section">
                            <h3>${section.title}</h3>
                            <p>${section.content.replace(/\n/g, '<br>')}</p>
                        </div>
                    `;
                }
            });

            // Get template-specific styles
            const templateStyles = getTemplateStyles(selectedTemplate);
            
            const html = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${name} - Resume (${selectedTemplate})</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            color: #333;
            line-height: 1.6;
        }
        .contact-info {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .resume-section {
            margin-bottom: 20px;
        }
        .skills {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .skill-tag {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
        }
        ${templateStyles}
        @media print {
            body { margin: 0; }
        }
    </style>
</head>
<body>
    <div class="resume-header resume-${selectedTemplate}">
        <h1>${name}</h1>
        <p>${title}</p>
        <div class="contact-info">
            ${contactInfo}
        </div>
    </div>
    ${sectionsHTML}
</body>
</html>`;

            downloadPDF(html, `${name.replace(/\s+/g, '_')}_${selectedTemplate}_Resume.pdf`);
        }

        // Download PDF
        async function downloadPDF(html = null, filename = 'resume.pdf') {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';

            try {
                const content = html || document.getElementById('resumePreview').innerHTML;
                
                const response = await fetch('/convert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        html: content,
                        filename: filename
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const error = await response.json();
                    alert('Error generating PDF: ' + error.error);
                }
            } catch (error) {
                alert('Error generating PDF: ' + error.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        // Upload HTML file
        function uploadHTML() {
            document.getElementById('htmlFile').click();
        }

        // Handle file upload
        async function handleFileUpload() {
            const fileInput = document.getElementById('htmlFile');
            const file = fileInput.files[0];
            
            if (!file) return;

            const formData = new FormData();
            formData.append('htmlFile', file);

            const loading = document.getElementById('loading');
            loading.style.display = 'block';

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.name.replace('.html', '.pdf');
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const error = await response.json();
                    alert('Error generating PDF: ' + error.error);
                }
            } catch (error) {
                alert('Error generating PDF: ' + error.message);
            } finally {
                loading.style.display = 'none';
                fileInput.value = '';
            }
        }

        // Clear form
        function clearForm() {
            document.getElementById('name').value = '';
            document.getElementById('title').value = '';
            document.getElementById('email').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('location').value = '';
            document.getElementById('linkedin').value = '';
            document.getElementById('sectionTitle').value = '';
            document.getElementById('sectionContent').value = '';
            currentResumeId = null;
            selectedTemplate = 'modern'; // Reset to default template
            
            // Reset template selection UI
            document.querySelectorAll('.template-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector('.template-option').classList.add('selected');
            
            initializeSections();
            updatePreview();
        }

        // Enhanced Preview Functions
        let isA4Mode = false;

        // Toggle A4 preview mode
        function togglePreviewMode() {
            const preview = document.getElementById('resumePreview');
            const btn = document.getElementById('previewModeBtn');
            
            isA4Mode = !isA4Mode;
            
            if (isA4Mode) {
                preview.classList.add('a4-mode');
                btn.innerHTML = 'üì± Normal Preview';
                btn.style.background = '#28a745';
            } else {
                preview.classList.remove('a4-mode');
                btn.innerHTML = 'üìÑ A4 Preview';
                btn.style.background = '#6c757d';
            }
        }

        // Refresh preview
        function refreshPreview() {
            updatePreview();
            // Add a visual feedback
            const preview = document.getElementById('resumePreview');
            preview.style.opacity = '0.7';
            setTimeout(() => {
                preview.style.opacity = '1';
            }, 200);
        }

        // Print preview
        function printPreview() {
            const printWindow = window.open('', '_blank');
            const previewContent = document.getElementById('resumePreview').innerHTML;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Resume Preview</title>
                    <style>
                        body {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            margin: 0;
                            padding: 20px;
                            color: #333;
                            line-height: 1.6;
                        }
                        .resume-header {
                            text-align: center;
                            border-bottom: 2px solid #667eea;
                            padding-bottom: 20px;
                            margin-bottom: 20px;
                        }
                        .resume-header h1 {
                            color: #667eea;
                            font-size: 2rem;
                            margin-bottom: 5px;
                        }
                        .contact-info {
                            display: flex;
                            justify-content: center;
                            gap: 20px;
                            flex-wrap: wrap;
                        }
                        .contact-info span {
                            color: #6c757d;
                        }
                        .resume-section {
                            margin-bottom: 20px;
                        }
                        .resume-section h3 {
                            color: #495057;
                            border-bottom: 1px solid #e9ecef;
                            padding-bottom: 5px;
                            margin-bottom: 10px;
                        }
                        .skills {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 10px;
                        }
                        .skill-tag {
                            background: #667eea;
                            color: white;
                            padding: 5px 12px;
                            border-radius: 15px;
                            font-size: 0.8rem;
                        }
                        @media print {
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${previewContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        // Data Persistence Functions
        let autoSaveTimer = null;
        let lastSavedTime = null;
        let currentResumeId = null;
        let selectedTemplate = 'modern'; // Added for template selection

        // Auto-save functionality
        function setupAutoSave() {
            // Auto-save every 30 seconds
            setInterval(autoSave, 30000);
            
            // Auto-save on form changes
            const formElements = document.querySelectorAll('input, textarea, select');
            formElements.forEach(element => {
                element.addEventListener('input', () => {
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(autoSave, 2000); // Save 2 seconds after last change
                });
            });
        }

        // Auto-save function
        async function autoSave() {
            try {
                const resumeData = getResumeData();
                const currentTime = new Date().toLocaleString();
                
                if (currentResumeId) {
                    // Update existing resume
                    await updateResumeInDatabase(currentResumeId, resumeData);
                } else {
                    // Save new resume
                    const result = await saveResumeToDatabase(resumeData);
                    currentResumeId = result.id;
                }
                
                lastSavedTime = currentTime;
                updateAutoSaveStatus();
                updateSavedResumesList();
            } catch (error) {
                console.error('Auto-save error:', error);
            }
        }

        // Update auto-save status display
        function updateAutoSaveStatus() {
            const statusElement = document.getElementById('autoSaveStatus');
            const lastSavedElement = document.getElementById('lastSaved');
            
            if (lastSavedTime) {
                statusElement.textContent = '‚úÖ Auto-saved';
                lastSavedElement.textContent = `Last saved: ${lastSavedTime}`;
            } else {
                statusElement.textContent = '‚è≥ Auto-save enabled';
                lastSavedElement.textContent = '';
            }
        }

        // Template selection function
        function selectTemplate(template) {
            selectedTemplate = template;
            
            // Update visual selection
            document.querySelectorAll('.template-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.closest('.template-option').classList.add('selected');
            
            // Update preview with new template
            updatePreview();
        }

        // Get template-specific styles
        function getTemplateStyles(template) {
            const styles = {
                modern: `
                    .resume-modern {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 30px;
                        text-align: center;
                        border-radius: 10px 10px 0 0;
                    }
                    .resume-modern h1 {
                        color: white;
                        font-size: 2.5rem;
                        margin-bottom: 10px;
                    }
                    .resume-modern p {
                        font-size: 1.2rem;
                        opacity: 0.9;
                    }
                    .resume-modern .contact-info {
                        margin-top: 15px;
                    }
                    .resume-modern .contact-info span {
                        color: white;
                        margin: 0 10px;
                    }
                    .resume-section h3 {
                        color: #667eea;
                        border-bottom: 2px solid #667eea;
                        padding-bottom: 8px;
                    }
                    .skill-tag {
                        background: #667eea;
                        color: white;
                    }
                `,
                minimal: `
                    .resume-minimal {
                        background: #f8f9fa;
                        padding: 25px;
                        text-align: center;
                        border: 2px solid #495057;
                        border-radius: 8px;
                    }
                    .resume-minimal h1 {
                        color: #495057;
                        font-size: 2.2rem;
                        margin-bottom: 8px;
                        font-weight: 300;
                    }
                    .resume-minimal p {
                        color: #6c757d;
                        font-size: 1.1rem;
                    }
                    .resume-minimal .contact-info {
                        margin-top: 12px;
                    }
                    .resume-minimal .contact-info span {
                        color: #6c757d;
                        margin: 0 8px;
                        font-size: 0.9rem;
                    }
                    .resume-section h3 {
                        color: #495057;
                        border-bottom: 1px solid #dee2e6;
                        padding-bottom: 5px;
                        font-weight: 500;
                    }
                    .skill-tag {
                        background: #495057;
                        color: white;
                        border: 1px solid #495057;
                    }
                `,
                creative: `
                    .resume-creative {
                        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
                        color: white;
                        padding: 30px;
                        text-align: center;
                        border-radius: 15px 15px 0 0;
                    }
                    .resume-creative h1 {
                        color: white;
                        font-size: 2.8rem;
                        margin-bottom: 12px;
                        font-weight: bold;
                        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                    }
                    .resume-creative p {
                        font-size: 1.3rem;
                        opacity: 0.95;
                        font-weight: 500;
                    }
                    .resume-creative .contact-info {
                        margin-top: 18px;
                    }
                    .resume-creative .contact-info span {
                        color: white;
                        margin: 0 12px;
                        font-weight: 500;
                    }
                    .resume-section h3 {
                        color: #ff6b6b;
                        border-bottom: 3px solid #4ecdc4;
                        padding-bottom: 10px;
                        font-weight: bold;
                    }
                    .skill-tag {
                        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
                        color: white;
                        font-weight: bold;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    }
                `,
                corporate: `
                    .resume-corporate {
                        background: #2c3e50;
                        color: white;
                        padding: 25px;
                        text-align: center;
                        border-radius: 5px 5px 0 0;
                    }
                    .resume-corporate h1 {
                        color: white;
                        font-size: 2.3rem;
                        margin-bottom: 8px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                    }
                    .resume-corporate p {
                        font-size: 1.1rem;
                        opacity: 0.9;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }
                    .resume-corporate .contact-info {
                        margin-top: 15px;
                    }
                    .resume-corporate .contact-info span {
                        color: #ecf0f1;
                        margin: 0 10px;
                        font-size: 0.9rem;
                    }
                    .resume-section h3 {
                        color: #2c3e50;
                        border-bottom: 2px solid #34495e;
                        padding-bottom: 8px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }
                    .skill-tag {
                        background: #34495e;
                        color: white;
                        border: 1px solid #2c3e50;
                        font-weight: 500;
                    }
                `
            };
            
            return styles[template] || styles.modern;
        }

        // Get current resume data
        function getResumeData() {
            return {
                name: document.getElementById('name').value,
                title: document.getElementById('title').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                location: document.getElementById('location').value,
                linkedin: document.getElementById('linkedin').value,
                sections: sections,
                template: selectedTemplate,
                lastModified: new Date().toISOString()
            };
        }

        // Load resume data
        function loadResumeData(data) {
            document.getElementById('name').value = data.name || '';
            document.getElementById('title').value = data.title || '';
            document.getElementById('email').value = data.email || '';
            document.getElementById('phone').value = data.phone || '';
            document.getElementById('location').value = data.location || '';
            document.getElementById('linkedin').value = data.linkedin || '';
            
            // Load template if saved
            if (data.template) {
                selectedTemplate = data.template;
                // Update template selection UI
                document.querySelectorAll('.template-option').forEach(option => {
                    option.classList.remove('selected');
                });
                const templateOption = document.querySelector(`[onclick="selectTemplate('${selectedTemplate}')"]`);
                if (templateOption) {
                    templateOption.classList.add('selected');
                }
            }
            
            if (data.sections && data.sections.length > 0) {
                sections = data.sections;
                sectionCounter = Math.max(...sections.map(s => parseInt(s.id.replace('section_', '0')))) + 1;
            }
            
            renderSections();
            updatePreview();
            autoSave();
        }

        // Database functions
        async function saveResumeToDatabase(resumeData) {
            const response = await fetch('/api/resumes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(resumeData)
            });
            
            if (!response.ok) {
                throw new Error('Failed to save resume');
            }
            
            return await response.json();
        }

        async function updateResumeInDatabase(id, resumeData) {
            const response = await fetch(`/api/resumes/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(resumeData)
            });
            
            if (!response.ok) {
                throw new Error('Failed to update resume');
            }
            
            return await response.json();
        }

        async function loadResumeFromDatabase(id) {
            const response = await fetch(`/api/resumes/${id}`);
            
            if (!response.ok) {
                throw new Error('Failed to load resume');
            }
            
            return await response.json();
        }

        async function getAllResumes() {
            const response = await fetch('/api/resumes');
            
            if (!response.ok) {
                throw new Error('Failed to fetch resumes');
            }
            
            return await response.json();
        }

        async function deleteResumeFromDatabase(id) {
            const response = await fetch(`/api/resumes/${id}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                throw new Error('Failed to delete resume');
            }
            
            return await response.json();
        }

        // Save resume with custom name
        async function saveResume() {
            try {
                const resumeData = getResumeData();
                const name = document.getElementById('name').value || 'Untitled Resume';
                
                const saveName = prompt('Enter a name for this resume:', name);
                if (!saveName) return;
                
                // Update the name in resume data
                resumeData.name = saveName;
                
                const result = await saveResumeToDatabase(resumeData);
                currentResumeId = result.id;
                
                updateSavedResumesList();
                alert(`Resume "${saveName}" saved successfully!`);
            } catch (error) {
                alert('Error saving resume: ' + error.message);
            }
        }

        // Load resume from saved list
        async function loadResume() {
            try {
                const resumes = await getAllResumes();
                
                if (resumes.length === 0) {
                    alert('No saved resumes found. Save a resume first!');
                    return;
                }
                
                const resumeNames = resumes.map(r => r.name);
                const selectedName = prompt('Enter the name of the resume to load:\n\nAvailable resumes:\n' + resumeNames.join('\n'));
                
                if (!selectedName) return;
                
                const selectedResume = resumes.find(r => r.name === selectedName);
                if (!selectedResume) {
                    alert('Resume not found!');
                    return;
                }
                
                loadResumeData(selectedResume);
                currentResumeId = selectedResume.id;
                alert(`Resume "${selectedName}" loaded successfully!`);
            } catch (error) {
                alert('Error loading resume: ' + error.message);
            }
        }

        // Export resume data as JSON file
        function exportResume() {
            const resumeData = getResumeData();
            const dataStr = JSON.stringify(resumeData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `resume_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // Import resume data from JSON file
        function importResume() {
            document.getElementById('importFile').click();
        }

        // Handle import file selection
        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const resumeData = JSON.parse(e.target.result);
                    loadResumeData(resumeData);
                    alert('Resume data imported successfully!');
                } catch (error) {
                    alert('Error importing resume data. Please check the file format.');
                }
            };
            reader.readAsText(file);
            
            // Clear the file input
            event.target.value = '';
        }

        // Update saved resumes list
        async function updateSavedResumesList() {
            try {
                const resumes = await getAllResumes();
                const resumesList = document.getElementById('resumesList');
                
                if (resumes.length === 0) {
                    resumesList.innerHTML = '<p style="color: #6c757d; font-style: italic;">No saved resumes yet</p>';
                    return;
                }
                
                let html = '';
                resumes.forEach(resume => {
                    const savedDate = new Date(resume.updated_at).toLocaleString();
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 5px; margin-bottom: 5px; border: 1px solid #e9ecef;">
                            <div>
                                <strong>${resume.name}</strong><br>
                                <small style="color: #6c757d;">Saved: ${savedDate}</small>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn btn-secondary" onclick="loadSavedResume(${resume.id})" style="padding: 3px 8px; font-size: 11px;">Load</button>
                                <button class="btn btn-danger" onclick="deleteSavedResume(${resume.id})" style="padding: 3px 8px; font-size: 11px;">Delete</button>
                            </div>
                        </div>
                    `;
                });
                
                resumesList.innerHTML = html;
            } catch (error) {
                console.error('Error updating resumes list:', error);
                const resumesList = document.getElementById('resumesList');
                resumesList.innerHTML = '<p style="color: #dc3545; font-style: italic;">Error loading resumes</p>';
            }
        }

        // Load a specific saved resume
        async function loadSavedResume(id) {
            try {
                const resume = await loadResumeFromDatabase(id);
                loadResumeData(resume);
                currentResumeId = resume.id;
                alert(`Resume "${resume.name}" loaded successfully!`);
            } catch (error) {
                alert('Error loading resume: ' + error.message);
            }
        }

        // Delete a saved resume
        async function deleteSavedResume(id) {
            try {
                const resume = await loadResumeFromDatabase(id);
                if (confirm(`Are you sure you want to delete "${resume.name}"?`)) {
                    await deleteResumeFromDatabase(id);
                    updateSavedResumesList();
                    alert(`Resume "${resume.name}" deleted successfully!`);
                    
                    // If we're currently editing this resume, clear the form
                    if (currentResumeId === id) {
                        currentResumeId = null;
                        clearForm();
                    }
                }
            } catch (error) {
                alert('Error deleting resume: ' + error.message);
            }
        }

        // Check for auto-saved data on page load
        function checkForAutoSavedData() {
            // This function is kept for future use if needed
            // Currently using database for persistence
        }

        // Initialize the application
        initializeSections();
        setupAutoSave();
        updateSavedResumesList();
        checkForAutoSavedData();
    </script>
</body>
</html> 